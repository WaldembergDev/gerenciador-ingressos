name: Resumo Autom谩tico de PR
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  resumir:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # Essencial para o rob么 comentar
    steps:
      - name: Checkout do c贸digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Pega o hist贸rico para conseguir comparar as branches

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Instalar depend锚ncias
        run: pip install -q -U google-generativeai

      - name: Gerar Resumo com Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<EOF
          import os
          import google.generativeai as genai
          import subprocess

          # 1. Configura a IA
          genai.configure(api_key=os.environ['GEMINI_API_KEY'])
          model = genai.GenerativeModel('gemini-pro')

          # 2. Captura o diff (mudan莽as) entre a base e a branch atual
          try:
              diff = subprocess.check_output(['git', 'diff', 'origin/main...HEAD']).decode('utf-8')
              
              if not diff:
                  resumo = "Nenhuma mudan莽a significativa detectada no c贸digo."
              else:
                  # 3. Solicita o resumo
                  prompt = f"Atue como um desenvolvedor s锚nior. Resuma as seguintes mudan莽as de c贸digo de forma clara, em t贸picos, focando no impacto para o projeto:\n\n{diff}"
                  response = model.generate_content(prompt)
                  resumo = "###  Resumo Autom谩tico (Gemini)\n\n" + response.text
          except Exception as e:
              resumo = f"Erro ao gerar resumo: {str(e)}"

          # 4. Cria um arquivo tempor谩rio com o resumo
          with open("comment.txt", "w", encoding="utf-8") as f:
              f.write(resumo)
          
          # 5. Usa o GitHub CLI para postar o coment谩rio no PR
          subprocess.run(['gh', 'pr', 'comment', os.environ['PR_NUMBER'], '--body-file', 'comment.txt'], check=True)
          EOF